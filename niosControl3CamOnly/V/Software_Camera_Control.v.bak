module Software_Camera_Control (
	clk, // pixel clk
	NiosSaysCapture, // nios is calibrated and ready to capture an image
	NiosSaysResetCaptureAndRunCam, // nios is preparing to calibrate the camera
	DoCapture, // tell the CCD module to capture
	DoRunCam ); // tell the CCD module to run the camera
	
	input NiosSaysCapture;
	input NiosSaysResetCaptureAndRunCam;
	output reg DoCapture;
	output reg DoRunCam;
	
	reg captureDone;
	reg runCamDone;
	
	always @(posedge clk) begin
		// this block controls the camera capture
		if (NiosSaysResetCaptureAndRunCam) begin
			// nios is preparing for a new image...we reset the
			// registers controlling the state of the capture
			DoCapture <= 1'b0;
			captureDone <= 1'b0;
		end
		else if (NiosSaysCapture && !DoCapture && !captureDone) begin
			// nios has requested a capture, so we prepare to do it on the next tick
			DoCapture <= 1'b1;
			captureDone <= 1'b0;
		end
		else if (DoCapture || captureDone) begin
			// we did a capture on this tick, or we've already done a capture
			DoCapture <= 1'b0;
			captureDone <= 1'b1;
		end
		else begin
			// nios hasn't requested a capture yet and we didn't capture yet
			DoCapture <= 1'b0;
			captureDone <= 1'b0;
		end
		
		// this block controls the camera running
		if (NiosSaysResetCaptureAndRunCam && !DoRunCam && !runCamDone) begin
			// nios has requested that we run the cam, so we prepare to do it
			// on the next tick
			DoRunCam <= 1'b1;
			runCamDone <= 1'b0;
		end
		else if (DoRunCam || runCamDone) begin
			// we started the cam on this tick, or we've already started the cam
			DoRunCam <= 1'b0;
			runCamDone <= 1'b1;
		end
		else begin
			// nios hasn't requested a that we start the cam yet and we didn't start it yet
			DoRunCam <= 1'b0;
			runCamDone <= 1'b0;
		end
	end
endmodule